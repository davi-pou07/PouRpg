<html>

<head>
    <meta charset="utf-8">
    <title>Meu Primeiro Jogo Multiplayer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
        <style>
            body{
                background-color: black;
            }
            canvas {
            border: 10px solid #CCC;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            width: 100%;
            height: 100%;
            }
        </style>
</head>

<body>
    <div class="container mt-3">
        <div class="row">
            <div class="col-8">
                <canvas width="800" height="600"></canvas>
            </div>
            <div class="col-4">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-center text-nowrap">PouRPG</h2>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="text-nowrap">Player</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                            <tr class="text-center">
                                                <th class="border-end text-center ">Id</th>
                                                <th class="border-start text-center ">Nick</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center text-nowrap">Pou</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center text-nowrap">Pou</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center text-nowrap">Pou</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center text-nowrap">Pou</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="text-nowrap">Score</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="text-center border-end text-nowrap">K</th>
                                                <th class="text-center border-end text-nowrap">M</th>
                                                <th class="text-center border-end text-nowrap">A</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                            </tr>
                                            <tr>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                                <td class="text-center border-end text-nowrap">1</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
   <script>
       	const screen = document.querySelector("canvas");
	    const context = screen.getContext("2d");
	    const currentPlayerId = 'Pou'
	
	    var spriteSheet = new Image();
	    spriteSheet.src = "../public/img/killer.png";

        function Sprite(img,srcX,srcY,posX,posY,width,height,speed){
            this.mvLeft = this.mvUp = this.mvRight = this.mvDown = false;
            this.srcX = srcX
            this.srcY = srcY;
	        //Posição no canvas onde a figura será exibida
	        this.posX = posX
            this.posY = posY;
	        this.width = width//32;
	        this.height = height//48;
	        this.speed = speed//1;
	        this.img = img;
	        this.countAnim = 0;

            this.draw = function(ctx){
		    ctx.drawImage(	this.img,	//Imagem de origem
						//Captura da imagem
						this.srcX,	//Origem da captura no eixo X
						this.srcY,	//Origem da captura no eixo Y
						this.width,	//Largura da imagem que será capturada
						this.height,//Altura da imagem que será capturada
						//Exibição da imagem
						this.posX,	//Posição no eixo X onde a imagem será exibida 
						this.posY,	//Posição no eixo Y onde a imagem será exibida 
						this.width,	//Largura da imagem a ser exibida 
						this.height	//Altura da imagem a ser exibida 
					);
                    this.animation()
	        }

            this.move = function(keyPressed){
                if(this.mvRight){
                //if this.posx += this.speed > screen.whidt
			    this.posX += this.speed;
			    this.srcY = this.height * 2; 
		        } else
		        if(this.mvLeft){
		        	this.posX -= this.speed;
		        	this.srcY = this.height * 1; 
		        } else
		        if(this.mvUp){
		        	this.posY -= this.speed;
		        	this.srcY = this.height * 3; 
		        } else
		        if(this.mvDown){
		        	this.posY += this.speed;
		        	this.srcY = this.height * 0; 
		        }
	        }

            this.animation = function(){
		        if(this.mvLeft || this.mvUp || this.mvRight || this.mvDown){
		        	//Caso qualquer seta seja pressionada, o contador de animação é incrementado
		        	this.countAnim++;
		        	if(this.countAnim >= 20){
		        		this.countAnim = 0;
		        	}
		        	this.srcX = Math.floor(this.countAnim / 5) * this.width;
		        } else {
		        	//Caso nenhuma tecla seja pressionada, o contador de animação é zerado e a imagem do personagem parado é exibida
		        	this.srcX = 0;
		        	this.countAnim = 0;
		        }
	        }
        }


	function creatrGame(){
        

		const state ={
			players:{
				"pou":new Sprite(spriteSheet,0,0,360,360,32,48,1)
			}
		}

        function addPlayer(command){
            const player = new Sprite(spriteSheet)
        }



		function movePlayer(command){

            const acceptedMoves = {
                ArrowRight(player){
                    player.mvRight = true;
				    player.mvLeft = false;
				    player.mvUp = false;
				    player.mvDown = false;
                    player.move()
                },
                ArrowLeft(player){
                    player.mvRight = false;
				    player.mvLeft = true;
				    player.mvUp = false;
				    player.mvDown = false;
                    player.move()
                },
                ArrowUp(player){
                    player.mvRight = false;
				    player.mvLeft = false;
				    player.mvUp = true;
				    player.mvDown = false;
                    player.move()
                },
                ArrowDown(player){
                    player.mvRight = false;
				    player.mvLeft = false;
				    player.mvUp = false;
				    player.mvDown = true;
                    player.move()
                }
            }

            const keyPressed = command.keyPressed
            console.log(keyPressed)
		    const player = state.players[command.playerId]
            const moveFunction = acceptedMoves[keyPressed]
            if (moveFunction) {
                moveFunction(player)
            }

            var LEFT = 37, UP = 38, RIGHT = 39, DOWN = 40;
            window.addEventListener("keyup",keyupHandler,false);
            function keyupHandler(e){
                switch(e.keyCode){
			    case RIGHT:
				    player.mvRight = false;
				break;
			    case LEFT:
				    player.mvLeft = false;
				break;
			    case UP:
				    player.mvUp = false;
				break;
			    case DOWN:
				    player.mvDown = false;
				break;
		    }
	        }
            /*
            switch(keyPressed){
			case RIGHT:
				player.mvRight = true;
				player.mvLeft = false;
				player.mvUp = false;
				player.mvDown = false;
				break;
			case LEFT:
				player.mvRight = false;
				player.mvLeft = true;
				player.mvUp = false;
				player.mvDown = false;
				break;
			case UP:
				player.mvRight = false;
				player.mvLeft = false;
				player.mvUp = true;
				player.mvDown = false;
				break;
			case DOWN:
				player.mvRight = false;
				player.mvLeft = false;
				player.mvUp = false;
				player.mvDown = true;
				break;
		    }
            

            player.move()

            
            */

		}
		return{
			movePlayer,
			state
		}
	}
    const game = creatrGame()
    const keyboardListener = createKeyboardListener()
    keyboardListener.subscribe(game.movePlayer)

function createKeyboardListener(){

    const state = {
        observers: []
    }

    function subscribe(observersFunction){
        state.observers.push(observersFunction)
    }

    function notifyAll(command){
        console.log(`Notificando ${state.observers.length} observers`)
        for(const observerFunction of state.observers){
            observerFunction(command)
        }
    }

	window.addEventListener("keydown",keydownHandler,false);

	function keydownHandler(e){
		const keyPressed = e.code
		const command = {
			playerId:'pou',
			keyPressed
		}
		notifyAll(command)

	}
    return{
        subscribe
    }
}


    renderScreen()

    function renderScreen(){
        for(const playerId in game.state.players){
            const player = game.state.players[playerId]
		    context.clearRect(0,0,screen.width,screen.height);
            player.draw(context)
        }

        requestAnimationFrame(renderScreen)
    }

	
   </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
</body>

</html>